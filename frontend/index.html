<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶í Watering Hole Tracker</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif; background: #0a0a0f; color: #e0e0e0; }

  .header { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1e1e2e; }
  .header h1 { font-size: 1.3em; }
  .header h1 span { font-size: 0.8em; color: #666; font-weight: 400; margin-left: 8px; }
  .status { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; }
  .status-dot.connected { background: #4ade80; box-shadow: 0 0 6px #4ade8066; }
  .status-dot.disconnected { background: #f87171; }
  .status-dot.waiting { background: #facc15; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

  .main { display: flex; height: calc(100vh - 57px); }

  .video-area { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; position: relative; overflow: hidden; }
  .video-area img { max-width: 100%; max-height: 100%; object-fit: contain; }
  .no-frame { color: #444; font-size: 1.2em; text-align: center; }
  .no-frame .spinner { font-size: 2em; animation: pulse 1.5s infinite; margin-bottom: 12px; }

  .sidebar { width: 280px; background: #0f0f18; border-left: 1px solid #1e1e2e; padding: 16px; overflow-y: auto; flex-shrink: 0; }
  .sidebar h2 { font-size: 0.9em; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }

  .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
  .stat-card { background: #13131a; border: 1px solid #1e1e2e; border-radius: 8px; padding: 10px; text-align: center; }
  .stat-label { font-size: 0.7em; color: #666; text-transform: uppercase; }
  .stat-value { font-size: 1.4em; font-weight: 700; margin-top: 2px; }

  .animal-list { display: flex; flex-direction: column; gap: 6px; }
  .animal-item { background: #13131a; border: 1px solid #1e1e2e; border-radius: 8px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
  .animal-name { font-weight: 600; text-transform: capitalize; }
  .animal-conf { font-size: 0.85em; color: #888; }
  .conf-bar { width: 50px; height: 4px; background: #1e1e2e; border-radius: 2px; overflow: hidden; margin-left: 8px; display: inline-block; vertical-align: middle; }
  .conf-fill { height: 100%; border-radius: 2px; background: #4ade80; }

  .animal-emoji { font-size: 1.2em; margin-right: 6px; }

  .log { margin-top: 20px; }
  .log h2 { margin-bottom: 8px; }
  .log-entries { font-size: 0.75em; color: #666; max-height: 200px; overflow-y: auto; }
  .log-entry { padding: 2px 0; border-bottom: 1px solid #111; }
  .log-time { color: #444; }

  @media (max-width: 768px) {
    .main { flex-direction: column; }
    .sidebar { width: 100%; max-height: 40vh; border-left: none; border-top: 1px solid #1e1e2e; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>ü¶í Watering Hole Tracker <span>Naledi Cat-EYE</span></h1>
  <div class="status">
    <div class="status-dot waiting" id="statusDot"></div>
    <span id="statusText">Connecting...</span>
    <span style="color:#444;margin-left:8px" id="fpsText"></span>
  </div>
</div>

<div class="main">
  <div class="video-area">
    <img id="videoFrame" style="display:none" />
    <div class="no-frame" id="noFrame">
      <div class="spinner">üì°</div>
      <div>Connecting to watering hole stream...</div>
      <div style="font-size:0.8em;color:#333;margin-top:8px">Starting detection pipeline</div>
    </div>
  </div>

  <div class="sidebar">
    <h2>Current Animals</h2>
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Animals</div>
        <div class="stat-value" id="animalCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Species</div>
        <div class="stat-value" id="speciesCount">0</div>
      </div>
    </div>

    <div class="animal-list" id="animalList">
      <div style="color:#444;font-size:0.85em;text-align:center;padding:20px">No animals detected yet</div>
    </div>

    <div class="log">
      <h2>Activity Log</h2>
      <div class="log-entries" id="logEntries"></div>
    </div>
  </div>
</div>

<script>
const EMOJIS = {
  bird: 'üê¶', cat: 'üê±', dog: 'üêï', horse: 'üê¥', sheep: 'üêë',
  cow: 'üêÑ', elephant: 'üêò', bear: 'üêª', zebra: 'ü¶ì', giraffe: 'ü¶í',
};

const wsUrl = `ws://${location.host}/ws`;
let ws = null;
let reconnectTimer = null;
let lastSpecies = new Set();

function connect() {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  dot.className = 'status-dot waiting';
  text.textContent = 'Connecting...';

  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    dot.className = 'status-dot connected';
    text.textContent = 'Connected';
    addLog('Connected to detection server');
  };

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.type === 'waiting') {
      dot.className = 'status-dot waiting';
      text.textContent = data.message;
      return;
    }

    if (data.type === 'frame') {
      // Update image
      const img = document.getElementById('videoFrame');
      const noFrame = document.getElementById('noFrame');
      img.src = 'data:image/jpeg;base64,' + data.image;
      img.style.display = 'block';
      noFrame.style.display = 'none';

      dot.className = 'status-dot connected';
      text.textContent = 'Live';
      document.getElementById('fpsText').textContent = `${data.fps} det/s`;

      // Update counts
      document.getElementById('animalCount').textContent = data.count;
      const species = new Set(data.detections.map(d => d.class));
      document.getElementById('speciesCount').textContent = species.size;

      // Log new arrivals/departures
      for (const s of species) {
        if (!lastSpecies.has(s)) addLog(`${EMOJIS[s] || 'üêæ'} ${s} appeared`);
      }
      for (const s of lastSpecies) {
        if (!species.has(s)) addLog(`${EMOJIS[s] || 'üêæ'} ${s} left`);
      }
      lastSpecies = species;

      // Update animal list
      const list = document.getElementById('animalList');
      if (data.detections.length === 0) {
        list.innerHTML = '<div style="color:#444;font-size:0.85em;text-align:center;padding:20px">No animals detected</div>';
      } else {
        // Group by species
        const grouped = {};
        for (const d of data.detections) {
          if (!grouped[d.class]) grouped[d.class] = { count: 0, maxConf: 0 };
          grouped[d.class].count++;
          grouped[d.class].maxConf = Math.max(grouped[d.class].maxConf, d.confidence);
        }
        list.innerHTML = Object.entries(grouped)
          .sort((a, b) => b[1].count - a[1].count)
          .map(([cls, info]) => `
            <div class="animal-item">
              <div>
                <span class="animal-emoji">${EMOJIS[cls] || 'üêæ'}</span>
                <span class="animal-name">${cls}</span>
                <span style="color:#666;font-size:0.8em"> √ó${info.count}</span>
              </div>
              <div class="animal-conf">
                ${(info.maxConf * 100).toFixed(0)}%
                <div class="conf-bar"><div class="conf-fill" style="width:${info.maxConf * 100}%"></div></div>
              </div>
            </div>
          `).join('');
      }
    }
  };

  ws.onclose = () => {
    dot.className = 'status-dot disconnected';
    text.textContent = 'Disconnected ‚Äî reconnecting...';
    reconnectTimer = setTimeout(connect, 3000);
  };

  ws.onerror = () => {
    ws.close();
  };
}

function addLog(msg) {
  const el = document.getElementById('logEntries');
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `<div class="log-entry"><span class="log-time">${time}</span> ${msg}</div>` + el.innerHTML;
  // Keep last 50
  while (el.children.length > 50) el.removeChild(el.lastChild);
}

connect();
</script>
</body>
</html>
