<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶í Watering Hole Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif; background: #0a0a0f; color: #e0e0e0; }
  .header { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1e1e2e; }
  .header h1 { font-size: 1.3em; }
  .header h1 span { font-size: 0.8em; color: #666; font-weight: 400; margin-left: 8px; }
  .status { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; }
  .status-dot.live { background: #4ade80; box-shadow: 0 0 6px #4ade8066; }
  .status-dot.loading { background: #facc15; animation: pulse 1.5s infinite; }
  .status-dot.error { background: #f87171; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

  .main { display: flex; height: calc(100vh - 57px); }
  .video-area { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
  .video-container { position: relative; width: 100%; height: 100%; }
  .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  #overlayCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
  #captureCanvas { display: none; }

  .sidebar { width: 280px; background: #0f0f18; border-left: 1px solid #1e1e2e; padding: 16px; overflow-y: auto; flex-shrink: 0; }
  .sidebar h2 { font-size: 0.9em; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
  .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
  .stat-card { background: #13131a; border: 1px solid #1e1e2e; border-radius: 8px; padding: 10px; text-align: center; }
  .stat-label { font-size: 0.7em; color: #666; text-transform: uppercase; }
  .stat-value { font-size: 1.4em; font-weight: 700; margin-top: 2px; }
  .animal-list { display: flex; flex-direction: column; gap: 6px; }
  .animal-item { background: #13131a; border: 1px solid #1e1e2e; border-radius: 8px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
  .animal-name { font-weight: 600; text-transform: capitalize; }
  .conf-bar { width: 50px; height: 4px; background: #1e1e2e; border-radius: 2px; overflow: hidden; margin-left: 8px; display: inline-block; vertical-align: middle; }
  .conf-fill { height: 100%; border-radius: 2px; background: #4ade80; }
  .animal-emoji { font-size: 1.2em; margin-right: 6px; }
  .log { margin-top: 20px; }
  .log h2 { margin-bottom: 8px; }
  .log-entries { font-size: 0.75em; color: #666; max-height: 200px; overflow-y: auto; }
  .log-entry { padding: 2px 0; border-bottom: 1px solid #111; }
  .log-time { color: #444; }

  .note { background: #1a1a0f; border: 1px solid #333300; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.8em; color: #cca; }

  @media (max-width: 768px) {
    .main { flex-direction: column; }
    .sidebar { width: 100%; max-height: 40vh; border-left: none; border-top: 1px solid #1e1e2e; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>ü¶í Watering Hole Tracker <span>Naledi Cat-EYE</span></h1>
  <div class="status">
    <div class="status-dot loading" id="statusDot"></div>
    <span id="statusText">Loading model...</span>
    <span style="color:#444;margin-left:8px" id="fpsText"></span>
  </div>
</div>

<div class="main">
  <div class="video-area">
    <div class="video-container">
      <iframe id="ytPlayer"
        src="https://www.youtube.com/embed/ydYDqZQpim8?autoplay=1&mute=1&enablejsapi=1&origin=${location.origin}"
        frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
      </iframe>
      <canvas id="overlayCanvas"></canvas>
    </div>
    <canvas id="captureCanvas"></canvas>
  </div>

  <div class="sidebar">
    <div class="note">
      ‚ö†Ô∏è <b>Cross-origin limitation</b>: YouTube iframes block direct frame capture. 
      Detection runs on periodic screenshots. For full real-time detection, 
      use the backend with stream cookies.
    </div>

    <h2>Current Animals</h2>
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Animals</div>
        <div class="stat-value" id="animalCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Species</div>
        <div class="stat-value" id="speciesCount">0</div>
      </div>
    </div>
    <div class="animal-list" id="animalList">
      <div style="color:#444;font-size:0.85em;text-align:center;padding:20px">Waiting for model to load...</div>
    </div>
    <div class="log">
      <h2>Activity Log</h2>
      <div class="log-entries" id="logEntries"></div>
    </div>
  </div>
</div>

<script>
const EMOJIS = {
  bird: 'üê¶', cat: 'üê±', dog: 'üêï', horse: 'üê¥', sheep: 'üêë',
  cow: 'üêÑ', elephant: 'üêò', bear: 'üêª', zebra: 'ü¶ì', giraffe: 'ü¶í',
};
const ANIMAL_CLASSES = new Set(['bird','cat','dog','horse','sheep','cow','elephant','bear','zebra','giraffe']);
const COLORS = {
  bird: '#00ffff', cat: '#ff00ff', dog: '#ffa500', horse: '#00a5ff',
  sheep: '#c8c8c8', cow: '#6464ff', elephant: '#808080', bear: '#3232c8',
  zebra: '#ffffff', giraffe: '#00c8c8',
};

let model = null;
let detecting = false;
let lastSpecies = new Set();
let frameCount = 0;

// Try to use a proxy image approach: capture YT thumbnail periodically
// Since we can't access iframe pixels due to cross-origin, we'll use
// the YouTube live thumbnail which updates every ~5 seconds

async function loadModel() {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  addLog('Loading COCO-SSD model...');

  try {
    model = await cocoSsd.load({ base: 'mobilenet_v2' });
    dot.className = 'status-dot live';
    text.textContent = 'Model loaded ‚Äî detecting';
    addLog('‚úÖ Model loaded, starting detection');
    startDetection();
  } catch (e) {
    dot.className = 'status-dot error';
    text.textContent = 'Model load failed';
    addLog('‚ùå Model failed: ' + e.message);
  }
}

// YouTube live thumbnails update in near real-time
function getThumbnailUrl() {
  // maxresdefault updates periodically for live streams
  return `https://i.ytimg.com/vi/ydYDqZQpim8/hqdefault_live.jpg?t=${Date.now()}`;
}

async function detectFrame() {
  if (detecting || !model) return;
  detecting = true;

  try {
    const img = new Image();
    img.crossOrigin = 'anonymous';

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = getThumbnailUrl();
    });

    const t0 = performance.now();
    const predictions = await model.detect(img);
    const dt = performance.now() - t0;

    // Filter to animals
    const animals = predictions.filter(p => ANIMAL_CLASSES.has(p.class) && p.score > 0.3);

    // Draw overlay
    const overlay = document.getElementById('overlayCanvas');
    const container = overlay.parentElement;
    overlay.width = container.clientWidth;
    overlay.height = container.clientHeight;
    const ctx = overlay.getContext('2d');
    ctx.clearRect(0, 0, overlay.width, overlay.height);

    // Scale factors (thumbnail is 480x360, overlay matches container)
    const sx = overlay.width / img.naturalWidth;
    const sy = overlay.height / img.naturalHeight;

    for (const pred of animals) {
      const [x, y, w, h] = pred.bbox;
      const dx = x * sx, dy = y * sy, dw = w * sx, dh = h * sy;
      const color = COLORS[pred.class] || '#00ff00';

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.strokeRect(dx, dy, dw, dh);

      const label = `${EMOJIS[pred.class] || ''} ${pred.class} ${(pred.score * 100).toFixed(0)}%`;
      ctx.font = '14px -apple-system, sans-serif';
      const tm = ctx.measureText(label);
      ctx.fillStyle = color;
      ctx.fillRect(dx, dy - 20, tm.width + 8, 20);
      ctx.fillStyle = '#000';
      ctx.fillText(label, dx + 4, dy - 5);
    }

    // Update UI
    document.getElementById('animalCount').textContent = animals.length;
    const species = new Set(animals.map(a => a.class));
    document.getElementById('speciesCount').textContent = species.size;
    document.getElementById('fpsText').textContent = `${(1000 / dt).toFixed(1)} det/s`;

    // Log new arrivals/departures
    for (const s of species) {
      if (!lastSpecies.has(s)) addLog(`${EMOJIS[s] || 'üêæ'} ${s} appeared`);
    }
    for (const s of lastSpecies) {
      if (!species.has(s)) addLog(`${EMOJIS[s] || 'üêæ'} ${s} left`);
    }
    lastSpecies = species;

    // Update animal list
    const list = document.getElementById('animalList');
    if (animals.length === 0) {
      list.innerHTML = '<div style="color:#444;font-size:0.85em;text-align:center;padding:20px">No animals detected</div>';
    } else {
      const grouped = {};
      for (const a of animals) {
        if (!grouped[a.class]) grouped[a.class] = { count: 0, maxConf: 0 };
        grouped[a.class].count++;
        grouped[a.class].maxConf = Math.max(grouped[a.class].maxConf, a.score);
      }
      list.innerHTML = Object.entries(grouped)
        .sort((a, b) => b[1].count - a[1].count)
        .map(([cls, info]) => `
          <div class="animal-item">
            <div>
              <span class="animal-emoji">${EMOJIS[cls] || 'üêæ'}</span>
              <span class="animal-name">${cls}</span>
              <span style="color:#666;font-size:0.8em"> √ó${info.count}</span>
            </div>
            <div style="font-size:0.85em;color:#888">
              ${(info.maxConf * 100).toFixed(0)}%
              <div class="conf-bar"><div class="conf-fill" style="width:${info.maxConf * 100}%"></div></div>
            </div>
          </div>
        `).join('');
    }

    frameCount++;

  } catch (e) {
    // Thumbnail may fail sometimes ‚Äî that's ok
    if (frameCount === 0) {
      document.getElementById('statusText').textContent = 'Waiting for stream thumbnail...';
    }
  }

  detecting = false;
}

function startDetection() {
  // Run detection every 2 seconds (thumbnail update rate)
  setInterval(detectFrame, 2000);
  detectFrame();
}

function addLog(msg) {
  const el = document.getElementById('logEntries');
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `<div class="log-entry"><span class="log-time">${time}</span> ${msg}</div>` + el.innerHTML;
  while (el.children.length > 50) el.removeChild(el.lastChild);
}

// Start
loadModel();
</script>
</body>
</html>
